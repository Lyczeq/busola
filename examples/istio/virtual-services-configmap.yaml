apiVersion: v1
kind: ConfigMap
metadata:
  name: virtual-services
  namespace: lyczeq
  labels:
    app.kubernetes.io/name: virtual-services
    busola.io/extension: resource
    busola.io/extension-version: '0.5'
data:
  dataSources: |-
    {
      "gateways":{
        "resource": {
          "kind": "Gateway",
          "group": "networking.istio.io",
          "version": "v1beta1",
          "namespace": null
        },
        "filter": "$filter($root.spec.http.route, function($r) { $filter($r.destination.host, function($h){$substringBefore($h, '.') = $item.metadata.name and $split($substringAfter($h, '.'),'.')[0] = $item.metadata.namespace} ) })"
      },
      "services":{
        "resource": {
          "kind": "Service",
          "version": "v1",
          "namespace": null
        },
        "filter": "$filter($root.spec.http.route, function($r) { $filter($r.destination.host, function($h){($substringBefore($h, '.') = $item.metadata.name) and ($split($substringAfter($h, '.'),'.')[0] = $item.metadata.namespace)} ) })"
      }
    }
  details: |
    {
      "resourceGraph":{
        "dataSources": [
          {
            "source": "gateways"
          },
          {
            "source": "services"
          }
        ]
      },
      "body":[
          {
            "widget": "Table",
            "source": "spec.gateways[]",
            "name": "Gateways",
            "children": [
            {
              "source": "$item",
              "name": "Name",
              "widget": "ResourceLink",
              "resource":{
                "kind": "'Gateway'",
                "name": "$contains(data,'/') ? $substringAfter(data, '/') : $substringBefore(data, '.')",
                "namespace": "$contains(data,'/') ? $substringBefore(data, '/'): $split($substringAfter(data, '.'),'.')[0] "
                # discuss that split -> default ns -> vs have gateways specified in a different way than in the Istio VS docs
              }
            }
            ]
          },
          {
            "name": "Hosts",
            "widget": "Panel",
            "children": [
              {"source": "spec.hosts", "widget": "Labels", "name": "Hosts"},
              {"name": "Export to", "source": "spec.exportTo", "widget": "Labels", "visibility": "$exists(*)"}
            ]
          },
          {
            "widget": "CodeViewer",
            "source": "spec.http",
            "name": "HTTP",
            "visibility": "$exists(*)"
          },
          {
            "widget": "Table",
            "source": "spec.http",
            "name": "HTTP",
            "visibility": "$exists(*)",
            "children": [
              {
               "source": "$item.name", "name": "Name"
              },
              {
                 "source": "$item.timeout", "name": "Timeout"
              },
              {
                 "source": "$item.mirrorPercentage.value", "name": "Mirror Percentage"
              },
              {
                "source": "$item.corsPolicy",
                "name": "CORS Policy", 
                "widget": "Panel", 
                "visibility": "$exists(*)",
                "children": [
                  {
                    "source": "$item.allowHeaders", "name": "Allow Headers", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.allowMethods", "name": "Allow Methods", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.maxAge", "name": "Max Age"
                  },
                ] 
              },
            ],
            "collapsible": [
              {
                "source": "$item.match", "name": "Matches", "widget": "Table", 
                "visibility": "$exists(*)", "children":[
                  {
                    "source": "$item.name", "name": "Name",
                  },
                  {
                    "source": "$item.uri", "name": "URI", "widget": "Labels",
                  },
                  {
                    "source": "$item.scheme", "name": "URI Scheme", "widget": "Labels",
                  },
                  {
                    "source": "$item.method", "name": "Method", "widget": "Labels",
                  },
                  {
                    "source": "$item.authority", "name": "Authority", "widget": "Labels",
                  },
                  {
                    "source": "$item.headers", "name": "Headers"
                  },
                  {
                    "source": "$item.port", "name": "Port"
                  },
                  {
                    "source": "$item.sourceLabels", "name": "Source Labels", "widget": "Labels"
                  },
                  {
                    "source": "$item.gateways", "name": "Gateways", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.queryParams", "name": "Query Params"
                  },
                  {
                    "source": "$item.ignoreUriCase", "name": "Ignore URI Case"
                  },
                  {
                    "source": "$item.withoutHeaders", "name": "Without Headers"
                  },
                  {
                    "source": "$item.sourceNamespace", "name": "Source namespace"
                  },
                ]
              },
              {
                "source": "$item.route", "name": "Routes", "widget": "Table", 
                "visibility": "$exists(*)", "children":[
                  {
                    "source": "$item.destination", "name": "Destination", "widget": "Panel", "visibility": "$exists(*)", "children": [
                      {
                        "source": "$item.host", "name": "Host"
                      },
                      {
                          "source": "$item.subset", "name": "Subset"
                      },
                      {
                        "source": "$item.port.number", "name": "Port"
                      },
                    ] 
                  },
                  {
                    "source": "$item.weight", "name": "Weight",
                  },
                  {
                    "source": "$item.headers", "name": "Headers", "widget": "Panel", 
                    "visibility": "$exists(*)", children": [
                        {
                          "source": "$item.request", "name": "Request", "widget": "Panel", 
                          "visibility": "$exists(*)", "children":[
                              {
                                "source": "$item.set", "name": "Set", "widget": "Labels"
                              },
                              {
                                "source": "$item.add", "name": "Add", "widget": "Labels"
                              },
                              {
                                "source": "$item.remove", "name": "Remove", "widget": "JoinedArray"
                              }
                          ]
                        },
                        {
                        "source": "$item.response", "name": "Response", "widget": "Panel", 
                        "visibility": "$exists(*)", "children": [
                              {
                                "source": "$item.set", "name": "Set", "widget": "Labels"
                              },
                              {
                                "source": "$item.add", "name": "Add", "widget": "Labels"
                              },
                              {
                                "source": "$item.remove", "name": "Remove", "widget": "JoinedArray"
                              }
                          ]
                        },
                    ] 
                  },
                ]
              },
              {
                "source": "$item.redirect", "name": "Redirect", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.uri", "name": "URI"
                  },
                  {
                    "source": "$item.authority", "name": "Authority"
                  },
                  {
                    "source": "$item.port", "name": "Port"
                  },
                  {
                    "source": "$item.derivePort", "name": "Derive Port", "widget": "Labels"
                  },
                  {
                    "source": "$item.scheme", "name": "Scheme"
                  },
                  {
                    "source": "$item.redirectCode", "name": "Redirect Code"
                  },
                ]
              },
              {
                "source": "$item.delegate", "name": "Delegate", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                    {
                      "source": "$item.name", "name": "Name"
                    },
                    {
                      "source": "$item.namespace", "name": "Namespace"
                    },
                ]
              },
              {
                "source": "$item.rewrite", "name": "Rewrite", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                    {
                      "source": "$item.uri", "name": "URI"
                    },
                    {
                      "source": "$item.authority", "name": "Authority"
                    },
                ]
              },
              {
                "source": "$item.retries", "name": "Retries", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                    {
                      "source": "$item.attempts", "name": "Attempts"
                    },
                    {
                      "source": "$item.perTryTimeout", "name": "Per Try Timeout"
                    },
                    {
                      "source": "$item.retryOn", "name": "Retry On"
                    },
                    {
                      "source": "$item.retryRemoteLocalities", "name": "Retry Remote Localities"
                    },
                ]
              },
              {
                "source": "$item.fault", "name": "Fault", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.delay", "name": "Delay", "widget": "Panel", 
                    "visibility": "$exists(*)", "children": [
                      {
                        "source": "$item.fixedDelay", "name": "Fixed Delay"
                      },
                      {
                        "source": "$item.percentage.value", "name": "Percentage"
                      },
                      {
                        "source": "$item.percent", "name": "Percent"
                      }
                    ]
                  },
                  {
                    "source": "$item.abort", "name": "Abort", "widget": "Panel", 
                    "visibility": "$exists(*)", "children": [
                      {
                        "source": "$item.httpStatus", "name": "HTTP Status"
                      },
                      {
                        "source": "$item.percentage.value", "name": "Percentage"
                      }
                    ]
                  }
                ]
              },
              {
                "source": "$item.mirror", "name": "Destination", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.host", "name": "Host"
                  },
                  {
                    "source": "$item.subset", "name": "Subset"
                  },
                  {
                    "source": "$item.port.number", "name": "Port"
                  },
                ]
              },
              {
                "source": "$item.corsPolicy", "name": "CORS Policy", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.allowOrigins", "name": "Allow Origins"
                  },
                  {
                    "source": "$item.allowMethods", "name": "Allow Methods", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.allowHeaders", "name": "Allow Headers", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.exposeHeaders", "name": "Expose Headers", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.maxAge", "name": "Max Age"
                  },
                  {
                    "source": "$item.allowCredentials", "name": "Allow Credentials"
                  }
                ]
              },
              {
                "source": "$item.headers", "name": "Headers", "widget": "Panel", 
                "visibility": "$exists(*)", "children": [
                    {
                      "source": "$item.request", "name": "Request", "widget": "Panel", 
                      "visibility": "$exists(*)", "children":[
                          {
                            "source": "$item.set", "name": "Set", "widget": "Labels"
                          },
                          {
                            "source": "$item.add", "name": "Add", "widget": "Labels"
                          },
                          {
                            "source": "$item.remove", "name": "Remove", "widget": "JoinedArray"
                          }
                      ]
                    },
                    {
                    "source": "$item.response", "name": "Response", "widget": "Panel", 
                    "visibility": "$exists(*)", "children": [
                          {
                            "source": "$item.set", "name": "Set", "widget": "Labels"
                          },
                          {
                            "source": "$item.add", "name": "Add", "widget": "Labels"
                          },
                          {
                            "source": "$item.remove", "name": "Remove", "widget": "JoinedArray"
                          }
                      ]
                    },
                ] 
              },
            ]
          },        
          {
            "widget": "Table",
            "source": "spec.tcp",
            "name": "TCP",
            "visibility": "$exists(*)",
            "children": [
                {
                "source": "$item.match", "name": "Matches", "widget": "Table", 
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.destinationSubnets", "name": "Destination Subnets",
                    "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.port", "name": "Port"
                  },
                  {
                    "source": "$item.sourceLabels", "name": "Source Labels", "widget": "Labels"
                  },
                  {
                    "source": "$item.gateways", "name": "Gateways", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.sourceNamespace", "name": "Source Namespace"
                  }
                ]
              },
            ],
            "collapsible": [
              {
                "source": "$item.route", "name": "Routes", "widget": "Table",
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.destination", "name": "Destination", "widget": "Panel", "visibility": "$exists(*)", "children": [
                      {
                        "source": "$item.host", "name": "Host"
                      },
                      {
                          "source": "$item.subset", "name": "Subset"
                      },
                      {
                        "source": "$item.port.number", "name": "Port"
                      },
                    ] 
                  },
                  {
                    "source": "$item.weight", "name": "Weight"
                  }
                ]
              },
            ],
          },
          {
            "widget": "Table",
            "source": "spec.tls",
            "name": "TLS",
            "visibility": "$exists(*)",
            "children": [
                {
                "source": "$item.match", "name": "Matches", "widget": "Table", 
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.sniHosts", "name": "SNI Hosts", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.destinationSubnets", "name": "Destination Subnets",
                    "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.port", "name": "Port"
                  },
                  {
                    "source": "$item.sourceLabels", "name": "Source Labels", "widget": "Labels"
                  },
                  {
                    "source": "$item.gateways", "name": "Gateways", "widget": "JoinedArray"
                  },
                  {
                    "source": "$item.sourceNamespace", "name": "Source Namespace"
                  }
                ]
              },
            ],
            "collapsible": [
              {
                "source": "$item.route", "name": "Routes", "widget": "Table",
                "visibility": "$exists(*)", "children": [
                  {
                    "source": "$item.destination", "name": "Destination", "widget": "Panel", "children": [
                      {
                        "source": "$item.host", "name": "Host"
                      },
                      {
                          "source": "$item.subset", "name": "Subset"
                      },
                      {
                        "source": "$item.port.number", "name": "Port"
                      },
                    ] 
                  },
                  {
                    "source": "$item.weight", "name": "Weight"
                  }
                ]
              }
            ],
          }
      ],
    }
  form: |-
    [
      {
        "path": "spec.tls", "simple": true, "widget": "GenericList", "name": "TLS", "children":[
          {
            "path": "[].match", "simple": true, "widget": "GenericList", "name": "Matches", "children": [

              {
                "path": "[].sourceNamespace", "simple": true, "name": "Source Namespace"
              },
              {
                "path": "[].port", "simple": true, "name": "Port"
              },
              {
                "path": "[].sniHosts", "simple": true, "widget": "SimpleList", "name": "SNI Hosts"
              },
              {
                "path": "[].destinationSubnets", "simple": true, "widget": "SimpleList", "name": "Destination Subnets"
              },
              {
                "path": "[].sourceLabels", "simple": true, "widget": "KeyValuePair", "name": "Source Labels"
              },
              {
                "path": "[].gateways", "simple": true, "widget": "SimpleList", "name": "Gateways"
              },

            ]
          },

          {
            "path": "[].route", "simple": true, "widget": "GenericList", "name": "Routes", "children": [

              {
                "path": "[].weight", "simple": true, "name": "Weight"
              },
              {
                "path": "[].destination", "simple": true, "widget": "FormGroup", "name": "Destination", "children": [

                  {
                    "path": "host", "simple": true, "name": "Host"
                  },
                  {
                    "path": "subset", "simple": true, "name": "Subset"
                  },
                  {
                    "path": "port.number", "simple": true, "name": "Port number"
                  }
                
                ]
              },


            ]
          },
        ]
      },

      {
        "path": "spec.tcp", "simple": true, "name": "TCP", "widget": "GenericList", "children": [

          {
            "path": "[].match", "simple": true, "name": "Matches", "children": [

              {
                "path": "[].sourceNamespace", "simple": true, "name": "Source Namespace"
              },
              {
                "path": "[].port", "simple": true, "name": "Port"
              },
              {
                "path": "[].sniHosts", "simple": true, "widget": "SimpleList", "name": "SNI Hosts"
              },
              {
                "path": "[].destinationSubnets", "simple": true, "widget": "SimpleList", "name": "Destination Subnets"
              },
              {
                "path": "[].sourceLabels", "simple": true, "widget": "KeyValuePair", "name": "Source Labels"
              },
              {
                "path": "[].gateways", "simple": true, "widget": "SimpleList", "name": "Gateways"
              }

            ]
          },

          {
            "path": "[].route", "simple": true, "name": "Routes", "children": [

              {
                "path": "[].weight", "simple": true, "name": "Weight"
              },
              {
                "path": "[].destination", "simple": true, "widget": "FormGroup", "name": "Destination", "children": [

                  {
                    "path": "host", "simple": true, "name": "Host"
                  },
                  {
                    "path": "subset", "simple": true, "name": "Subset"
                  },
                  {
                    "path": "port.number", "simple": true, "name": "Port number"
                  }
                
                ]
              },

            ]
          },

        ]
      },


      {
        "path": "spec.http", "simple": true, "name": "HTTP", "widget": "GenericList","children":[

          {
            "path": "[].route", "simple": true, "name": "Routes", "children": [

              {
                "path": "[].weight", "simple": true, "name": "Weight"
              },
              {
                "path": "[].destination", "simple": true, "name": "Destination", "widget": "FormGroup", "children": [

                  {
                    "path": "host", "simple": true, "name": "Host"
                  },
                  {
                    "path": "subset", "simple": true, "name": "Subset"
                  },
                  {
                    "path": "port.number", "simple": true, "name": "Port number"
                  }
                
                ]
              },
              {
                "path": "[].headers", "simple": true, "name": "Headers", "widget": "FormGroup", "children": [

                  {
                    "path": "response", "simple": true, "name": "Response", "widget": "FormGroup", "children": [
                    
                      {
                        "path": "set", "simple": true, "name": "Set", "widget": "KeyValuePair" 
                      },
                      {
                        "path": "add", "simple": true, "name": "Add", "widget": "KeyValuePair" 
                      },
                      {
                        "path": "remove", "simple": true, "name": "Remove", "widget": "KeyValuePair" 
                      },

                    ]
                  },
                  {
                    "path": "request", "simple": true, "name": "Request", "widget": "FormGroup", "children": [
                    
                      {
                        "path": "set", "simple": true, "name": "Set", "widget": "KeyValuePair" 
                      },
                      {
                        "path": "add", "simple": true, "name": "Add", "widget": "KeyValuePair" 
                      },
                      {
                        "path": "remove", "simple": true, "name": "Remove", "widget": "KeyValuePair" 
                      },

                    ]
                  }

                ]
              }
              

            ]
          },

            {
              "path": "[].corsPolicy", "simple": true, "name": "CORS Policy", "widget": "FormGroup", "children": [
                {
                  "path": "allowCredentials", "simple": true, "name": "Allow Credentials", "type": "boolean"
                }, 
                {
                  "path": "allowMethods", "simple": true, "name": "Allow Methods", "widget": "SimpleList"
                },
                {
                  "path": "allowHeaders", "simple": true, "name": "Allow Headers", "widget": "SimpleList"
                },
                {
                  "path": "exposeHeaders", "simple": true, "name": "Expose Headers", "widget": "SimpleList"
                },
                {
                  "path": "maxAge", "simple": true, "name": "Max Age"
                }
              ]
            }

        ] 
      },


      {
        "path": "spec.hosts", "simple": true , "name": "Hosts", "widget": "SimpleList"
      },
      {
        "path": "spec.gateways", "simple": true, "name": "Gateways", "widget": "SimpleList"
      },
      {
        "path": "spec.exportTo", "name": "Export To", "widget": "SimpleList"
      },
    ]
  general: |-
    {
      "resource": {
        "kind": "VirtualService",
        "group": "networking.istio.io",
        "version": "v1beta1"
      },
      "urlPath": "lyczeq-vs",
      "category": "Lyczeq",
      "scope": "namespace",
      "description": "{{[VirtualService](https://istio.io/latest/docs/reference/config/networking/virtual-service/)}} describes a configuration that affects traffic routing. ."
    }
  list: |-
    [
      { 
        "name": "Hosts",
        "source": "spec.hosts",
        "widget": "JoinedArray"
      },
      { 
        "name": "Gateways",
        "source": "spec.gateways",
        "widget": "JoinedArray"
      },
    ]
